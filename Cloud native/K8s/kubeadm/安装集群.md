### 一、[安装集群](https://blog.csdn.net/qq_25147521/article/details/105129037)

***

```shell
# 配置 /etc/hosts
cat >>/etc/hosts << EOF
172.16.167.110 k8snode1
172.16.167.120 k8snode2
172.16.167.130 k8snode3
EOF

# 开启转发
echo "1"> /proc/sys/net/ipv4/ip_forward
sysctl -p

# 加载内核模块
cat > /etc/sysconfig/modules/ipvs.modules <<EOF
 #!/bin/bash
 modprobe -- br_netfilter
 modprobe -- ip_vs
 modprobe -- ip_vs_rr
 modprobe -- ip_vs_wrr
 modprobe -- ip_vs_sh
 modprobe -- nf_conntrack_ipv4
 EOF
chmod 755 /etc/sysconfig/modules/ipvs.modules && \
bash /etc/sysconfig/modules/ipvs.modules && \
lsmod | grep -E "ip_vs|nf_conntrack_ipv4"
nf_conntrack_ipv4      15053  0
nf_defrag_ipv4         12729  1 nf_conntrack_ipv4
ip_vs_sh               12688  0
ip_vs_wrr              12697  0
ip_vs_rr               12600  0
ip_vs                 141432  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr
nf_conntrack          133053  2 ip_vs,nf_conntrack_ipv4
libcrc32c              12644  3 xfs,ip_vs,nf_conntrack
[root@k8snode3 ~]#
```

### 二、安装docker

***

```shell
yum install -y yum-utils

yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

yum install -y docker-ce

mkdir /etc/docker

cat > /etc/docker/daemon.json << EOF
{
    "exec-opts": ["native.cgroupdriver=systemd"],
    "log-driver": "json-file",
    "log-opts": {
        "max-size": "100m",
        "max-file": "10"
    },
    "bip": "169.254.123.1/24",
    "oom-score-adjust": -1000,
    "registry-mirrors": ["https://pqbap4ya.mirror.aliyuncs.com"],
    "storage-driver": "overlay2",
    "storage-opts":["overlay2.override_kernel_check=true"],
    "live-restore": false
}
EOF

systemctl restart docker
systemctl enable docker

cat > /etc/sysctl.d/kubernetes.conf << EOF
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
net.ipv4.ip_forward=1
net.ipv4.tcp_tw_recycle=0
vm.swappiness=0 # 禁止使用 swap 空间，只有当系统 OOM 时才允许使用它
vm.overcommit_memory=1 # 不检查物理内存是否够用
vm.panic_on_oom=0 # 开启 OOM
fs.inotify.max_user_instances=8192
fs.inotify.max_user_watches=1048576
fs.file-max=52706963
fs.nr_open=52706963
net.ipv6.conf.all.disable_ipv6=1
net.netfilter.nf_conntrack_max=2310720
EOF

sysctl -p /etc/sysctl.d/kubernetes.conf
```

### 三、安装kubeadm、kubelet、kubectl

***

```shell
cat > /etc/yum.repos.d/kubernetes.repo <<EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

yum install -y kubelet kubeadm kubectl
systemctl enable kubelet
```

### 四、配置kubeadm-config.yaml

***

* 创建默认的kubeadm-config.yaml

```
kubeadm config print init-defaults  > kubeadm-config.yaml
```

- InitConfiguration： 用于定义一些初始化配置，如初始化使用的token以及apiserver地址等
- ClusterConfiguration：用于定义apiserver、etcd、network、scheduler、controller-manager等master组件相关配置项
- KubeletConfiguration：用于定义kubelet组件相关的配置项
- KubeProxyConfiguration：用于定义kube-proxy组件相关的配置项

```shell
W0420 13:13:16.202865   12526 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]
```

* 配置详细内容

```yaml

```

***

* 初始化master节点

```shell
kubeadm init --apiserver-advertise-address=172.16.167.110  --image-repository registry.aliyuncs.com/google_containers --kubernetes-version v1.17.0 --service-cidr=10.1.0.0/16 --pod-network-cidr=10.244.0.0/16
```

* 默认token的有效期为24小时，当过期之后，该token就不可用了，如果后续有nodes节点加入，解决方法如下：`重新生成新的token ==> kubeadm token create`

```shell
# 1.查看当前的token列表
[root@K8S00 ~]# kubeadm token list
TOKEN                     TTL         EXPIRES                     USAGES                   DESCRIPTION                                                EXTRA GROUPS
7mjtn4.9kds6sabcouxaugd   23h         2019-12-24T15:44:58+08:00   authentication,signing   The default bootstrap token generated by 'kubeadm init'.   system:bootstrappers:kubeadm:default-node-token

# 2.重新生成新的token
[root@K8S00 ~]# kubeadm token create
369tcl.oe4punpoj9gaijh7

# 3.再次查看当前的token列表
[root@K8S00 ~]# kubeadm token list
TOKEN                     TTL         EXPIRES                     USAGES                   DESCRIPTION                                                EXTRA GROUPS
369tcl.oe4punpoj9gaijh7   23h         2019-12-24T16:05:18+08:00   authentication,signing   <none>                                                     system:bootstrappers:kubeadm:default-node-token
7mjtn4.9kds6sabcouxaugd   23h         2019-12-24T15:44:58+08:00   authentication,signing   The default bootstrap token generated by 'kubeadm init'.   system:bootstrappers:kubeadm:default-node-token

# 4.获取ca证书sha256编码hash值
[root@K8S00 ~]# openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'
7ae10591aa593c2c36fb965d58964a84561e9ccd416ffe7432550a0d0b7e4f90

# 5.节点加入集群
[root@k8s-node03 ~]# kubeadm join --token 369tcl.oe4punpoj9gaijh7(新的token) --discovery-token-ca-cert-hash sha256:7ae10591aa593c2c36fb965d58964a84561e9ccd416ffe7432550a0d0b7e4f90(ca证书sha256编码hash值) 172.22.34.31:6443 --skip-preflight-chec
```

***

* 添加node

```shell
Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:
#执行下面的，就可以用kubectl访问集群了
  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

#集群添加节点
kubeadm join 172.16.167.110:6443 --token np7jp9.9alkq321m3oozcc2 \
    --discovery-token-ca-cert-hash sha256:7f49d96b49a3065b39ec52b1fac848e511a307cb98830290d6f2a1c17ba2c089
```

### 五、安装网络插件

***

```shell
wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
# 上面要是不能用的话，可以通过访问下面地址，然后拷贝自己机器架构的部分
# https://github.com/coreos/flannel/blob/master/Documentation/kube-flannel.yml

kubectl apply -f kube-flannel.yml
```

### 六、查看状态

***

```shell
[root@k8snode1 flannel]# kubectl get nodes
NAME       STATUS   ROLES    AGE   VERSION
k8snode1   Ready    master   38m   v1.18.2
k8snode2   Ready    <none>   34m   v1.18.2
k8snode3   Ready    <none>   35m   v1.18.2
[root@k8snode1 flannel]#
[root@k8snode1 flannel]# kubectl get pods -n kube-system
NAME                               READY   STATUS    RESTARTS   AGE
coredns-7ff77c879f-9mjjf           1/1     Running   0          37m
coredns-7ff77c879f-b7zbx           1/1     Running   0          37m
etcd-k8snode1                      1/1     Running   0          38m
kube-apiserver-k8snode1            1/1     Running   0          38m
kube-controller-manager-k8snode1   1/1     Running   0          38m
kube-flannel-ds-amd64-jgkcb        1/1     Running   0          58s
kube-flannel-ds-amd64-kxsh2        1/1     Running   0          58s
kube-flannel-ds-amd64-p27dn        1/1     Running   0          58s
kube-proxy-7cqc6                   1/1     Running   0          37m
kube-proxy-p8f6b                   1/1     Running   0          35m
kube-proxy-z6s4v                   1/1     Running   0          35m
kube-scheduler-k8snode1            1/1     Running   0          38m
[root@k8snode1 flannel]#
```

### 七、下载可视化工具 octant

***

* 下载、安装

```
https://github.com/vmware/octant/releases
```

* 配置环境变量，然后运行

```shell
tee /usr/lib/systemd/system/octant.service <<-'EOF'
[Unit]
Description=octant

[Service]
Environment="HOME=/root"
Environment="OCTANT_ACCEPTED_HOSTS=172.16.167.110"
Environment="KUBECONFIG=/root/.kube/config"
Environment="OCTANT_LISTENER_ADDR=0.0.0.0:8900"
Environment="OCTANT_DISABLE_OPEN_BROWSER=true"
Environment="PATH=/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin"
WorkingDirectory=/usr/local/bin/
ExecStart=/usr/local/bin/octant
Type=simple
Restart=on-failure

[Install]
WantedBy=multi-user.target

EOF
```

* 赋予权限

```shell
chmod 755 -R /usr/lib/systemd/system/octant.service
```

